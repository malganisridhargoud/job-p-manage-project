<!-- public/my-applications.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>My Applications</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <div class="container">
    <header>
      <h1>My Applications</h1>
      <nav>
        <a href="/">Browse Jobs</a>
      </nav>
    </header>

    <section class="search">
      <input id="emailInput" placeholder="Enter your email to fetch applications" />
      <button id="fetchBtn">Fetch</button>
    </section>

    <section id="appsList" class="jobs"></section>
  </div>

  <script>
    async function fetchApps() {
      const email = document.getElementById('emailInput').value.trim();
      if (!email) return alert('Enter email');
      const res = await fetch('/api/applications?email=' + encodeURIComponent(email));
      const json = await res.json();
      if (!json.success) return alert(json.message || 'Failed');
      const list = document.getElementById('appsList');
      list.innerHTML = '';
      if (json.data.length === 0) list.innerHTML = '<p>No applications found.</p>';
      json.data.forEach(app => {
        const el = document.createElement('div');
        el.className = 'card';
        el.innerHTML = `
          <h3>${escapeHtml(app.jobTitle)} - <small>${escapeHtml(app.name)}</small></h3>
          <p><b>Applied:</b> ${new Date(app.appliedAt._seconds ? app.appliedAt._seconds * 1000 : app.appliedAt).toLocaleString()}</p>
          <p><b>Email:</b> ${escapeHtml(app.email)}</p>
          <p><b>Resume:</b><br/>${escapeHtml(app.resume)}</p>
          <button data-id="${app.id}" class="deleteBtn">Delete</button>
        `;
        list.appendChild(el);
      });

      document.querySelectorAll('.deleteBtn').forEach(b => {
        b.addEventListener('click', async (e) => {
          const id = e.target.dataset.id;
          if (!confirm('Delete this application?')) return;
          const resp = await fetch('/api/applications/' + id, { method: 'DELETE' });
          const j = await resp.json();
          if (j.success) {
            alert('Deleted');
            fetchApps();
          } else alert(j.message || 'Delete failed');
        });
      });
    }

    function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m]); }

    document.getElementById('fetchBtn').addEventListener('click', fetchApps);
  </script>
</body>
</html>
